%------------------------------------------------------------------------------
\chapter{Numerical Recipe}
\label{chap:Numerical_Recipe}
%-------------------------------
%------------------------------------------------------------------------------
\section{Brief Overview of Numerical Models}
\label{sec:models}
%------------------------------------------------------------------------------
How spicules are driven is one of the main issues currently facing solar physicists. The two main avenues of investigation for this phenomenon are observations and numerical simulations. Historically, it has been challenging to spatially/temporally resolve spicular structures and the properties on which to base models have been unclear. This has led to a plethora of numerical models. These models have been reviewed by \cite{Sterling_2000SoPh} and \cite{Aschwanden2019ASSL}, and can broadly be split into the following categories: pressure/velocity pulse in lower/upper chromosphere leading to formation of shocks \citep{Shibata1982,Suematsu1982SoPh7599S,Hollweg1982ApJ257345H,Sterling1990ApJ349647S,Heggland2007ApJ6661277H,kuzma2017ApJ84978K}, p-mode leakage \citep{Pontieu2004Natur},  \Alfven waves which can non-linearly couple and form shocks \citep{Hollweg1982SoPh7535H,Hollweg1992ApJ389731H, Kudoh1999ApJ514493K, Matsumoto2010ApJ7101857M}, magnetic reconnection \citep{Yokoyama1995Natur37542Y,Yokoyama1996PASJ48353Y, Archontis2005ApJ6351299A, Pontieu2007PASJ,Isobe2008ApJ679L57I,Nishizuka2008ApJ683L83N,Sterling2010ApJ,Gonz2017ApJ,Gonz2018arXiv180704224G,Gonz2018ApJ856176G}, joule heating due to ion-neutral collisional dampening \citep{Haerendel1992Natur360241H,James2002AA393L11J,James2003AA,Erd2004AA4271055E}, MHD kink waves \citep{Kukhianidze2006AA}, and vortical flows which lead to torsional \Alfven waves that drives spicules \citep{Iijima2017ApJ,Samanta2019Sci}. \np
%
It is important to note that the goal of this thesis is not to determine the origins of spicules. We are mainly focusing on the dynamics and morphology of the jet once it is initiated. For this reason, we decided to establish a method of applying a pulse based, driver and we will give a brief overview of the dynamics of these types of models. 
%------------------------------------------------------------------------------
\subsection{Pulse models}
\label{ssec:pulse_model}
%------------------------------------------------------------------------------
Pulse model simulations start with a form of energy deposition in the photosphere or chromosphere that drives material upwards from these regions into the corona. These types of numerical simulations originated in the 1980s, when \cite{Hollweg1982ApJ257345H} developed the rebound shock model which is triggered with a velocity pulse, \cite{Suematsu1982SoPh7599S} placed a pressure pulse in the lower atmosphere, and  \cite{Shibata1982} carried out simulations with pressure pulses in the upper chromosphere. \cite{Sterling_2000SoPh} breaks the velocity pulse into two categories; (i) strong pulse in the lower atmosphere, which covers the photosphere to the low chromosphere, produce initial upward velocities of $\sim 60\kms$ for initial velocities; (ii) weak pulse in the lower atmosphere i.e. the rebound shock model, which has upward velocities in the range of $\sim 1 \kms$. \np
%
\cite{Hollweg1982ApJ257345H} takes a weak pulse of $1\kms$ which is similar to velocities of granular motions at the base of his simulations. Due to the increasing temperature profile of the solar atmosphere, any waves created by disturbing the atmosphere are steepened as they travel upwards. When a wave steepens enough it can form a shock, which lifts the local material. When this lifted material falls back due to gravity, it compresses the lower atmosphere triggering a new wave, which then can propagate upwards and steepen, triggering more rebound shocks. \cite{Hollweg1982ApJ257345H} tried to use this model to explain the formation of spicules as the opposing forces exerted by rebound shocks and gravity, cause the TR to undulate, which he interprets as spicules. \cite{Hollweg1982ApJ257345H} shows this model meets some of the characteristics of spicules as the motion of TR could appear as non-ballistic, with comparable mean upward velocities, heights, temperature, and density. Numerous models have built upon the rebound shock model, by including radiation and heat conduction \citep{Sterling1988ApJ327950S, Sterling1990ApJ349647S, Cheng1992AA266549C, Cheng1992AA262581C, Cheng1992AA266537C}. With the inclusion of more sophisticated physics it becomes challenging to reproduce spicule characteristics. For example, when \cite{Sterling1990ApJ349647S} added realistic radiation losses, they were not able to obtain spicule heights greater than $6~\rm{Mm}$. \cite{Cheng1992AA266549C, Cheng1992AA266537C} used both radiation losses and ionization. He found the only way of generating jets with properties similar to spicules was by having a longer driving time. Recent simulations carried out by \cite{Heggland2007ApJ6661277H} used longer driving times. They showed how to generate chromospheric jets in which radiation losses and ionization could be considered, by placing a monochromatic piston driver at the base of the simulation with velocities (driving times) in the range of $0.2-1.1\kms$ ($180-360~\rm{s}$). \np
%
\cite{Suematsu1982SoPh7599S} carried out a 1D HD numerical experiment using a strong pulse low in a stratified solar atmosphere. These pulses were initiated by enhancing the pressure ($p/p_0=1.1-5.0$, where $p_0$ is local atmospheric pressure) near the base of the simulation in the region of the photosphere to the low chromosphere ($0.00-0.75~\rm{Mm}$), with driving times of $5~\rm{mins}$. These parameters were chosen based on observations of bright points in the chromosphere which are thought to be linked to the presence of spicules \citep{Suematsu1995ApJ, Jess2012ApJ744L5J, Oxley_2020ApJ905168O}. The pressure enhancement leads to the formation of waves that steepen as they travel upwards. When a wave reaches the steep temperature gradient of the TR it produces strong bi-directional shock waves that lift the TR region. The material behind the perturbed TR is interpreted as a spicule. In this model, rebound shock will occur, but the main difference is that, it is the initial pressure pulse itself, not the rebound shock, that lifts the TR. This model can capture parts of the spicule properties, and results in cool spicules (approx. $10^4~\rm{k}$) with a density of $10^{-13}~\rm{g~cm^{-3}}$, and reaching heights of $3.7-14~\rm{Mm}$. Although the average rise velocity of the spicule of 30 km/s  is in the range of observed spicule speeds, in order to reach the upper end of possible spicule heights, the initial velocity of the top of the spicules must be in the range of 50 - 80 km/s, which is the higher limit of observed spicule velocities. These models were further investigated by \cite{Shibata1982SoPh78333S} and \cite{Shibata1982}, who both studied a wider range of pulse strengths ($1.5 \le p/p_0 \le 30$), a wider variety of pulse heights ($0.18-1.92$), placing the TR at different heights TR. In both studies, they find that if the length between the pressure pulse and TR is reduced then this results in shorter spicules. This is because the waves have less distance to traverse, therefore less atmosphere to steepen in, which causes the shocks to be weaker. \np
%
Another location pressure pulse is placed in the upper chromosphere to simulate spicules. The justification for pressure enhancement at these locations can be created as a consequence of magnetic reconnection. An early example of these models was carried out by \cite{Shibata1982}. These were 1D HD simulations used to investigate the properties of surges, excluding radiation and heat conduction. As stated previously, \cite{Shibata1982} took a large range of pulse heights and strengths. They found that depending on the height which the pulse is located, two different types of jet formation can result, referred to as shock tube jet (above middle chromosphere) and crest shock jet (below middle chromosphere). The shock tube jet is when the pulse itself is responsible for lifting the TR, whereas in the crest shock, the TR is lifted due to a slow shock wave created by the pressure pulse. Compared to the other pulse models there seems to be renewed interest in pressure/velocity pulses just below the TR \citep{Murawski2010AA519A8M, Smirnova2016SoPh2913207S, Kuzma2017AA597A133K, kuzma2017ApJ84978K, Singh2019}. These models include more realistic physics for simulating spicules, such as the inclusion of a magnetic field, radiation losses, thermal conduction, and multi-fluid. They are also able to obtain results in the ranges of spicules height, speeds, temperatures, densities, and trajectories. The resurgence in the upper pulse model may be linked to strong interest in magnetic reconnection as a proposed driver for solar jets, including spicules \citep{Yokoyama1995Natur37542Y, Yokoyama1996PASJ48353Y, Pontieu2007PASJ, Gonz2017ApJ, Gonz2018ApJ856176G}.
%--------------------------------------------------------
\section{MPI-AMRVAC}
%--------------------------------------------------------
All the simulations carried out in this thesis use the open source software Message Passing Interface Adaptive Mesh Refinement Versatile Advection Code (MPI-AMRVAC). This software is developed in Fortran 90 parallelized with Message Passing Interface (MPI) \citep{toth1996ApLC34245T,Keppens_2012,Porth_2014,Xia_2017}. The main focus of this software is maintaining conservation laws in shock dominated problems. This is achieved using shock capturing schemes to retain near-conservation for a set of hyperbolic partial differential equations, typical in conservative form,
\begin{equation}\label{AMRVAC_stlye}
\frac{\partial \boldsymbol{U}}{\partial t} + \nabla \cdot \boldsymbol{F}(\boldsymbol{U}) = \boldsymbol{S}_{phys} (\boldsymbol{U}, \partial_{i} \boldsymbol{U}, \partial_i \partial_j \boldsymbol{U},\boldsymbol{x},t) ,
\end{equation}
where $U$ is the set of conserved variables, $F(U)$ the corresponding fluxes, and $S_{phys}$ are the source terms. The source terms are used to add extra physics, such as gravity, diffusion, and viscosity. In our case, the governing MHD equations are solved in their conservative form (including gravity as an additional source term),
\begin{equation} \label{eq1}
\partial_t \rho + \bn \cdot (\bs{v} \rho) = 0,
\end{equation}   
\begin{equation}\label{eq2}
\partial_t (\rho \bs{v})  + \bn \cdot ( \bs{v} \rho \bs{v} - \bs{BB}) + \bn p_{tot} = \rho \bs{g},
\end{equation}
\begin{equation}\label{eq3}
\partial_t e + \bn \cdot (\bs{v} e - \bs{BB}\cdot\bs{v}+\bs{v}p_{tot}) = \rho \bs{g} \cdot \bs{v},
\end{equation}
\begin{equation}\label{eq4}
\partial_t \bs{B} + \bn \cdot (\bs{vB}-\bs{Bv} ) = 0.
\end{equation}
Above is the full system of MHD equations employed in our model, with variables denoted as: time ($t$), mass density ($\rho$), plasma velocity $\bs{v}$, magnetic field ($\bs{B}$). The total pressure ($p_{tot}$) and energy density ($e$) terms are given as,
\begin{equation}
p_{tot} = p+\frac{\bs{B}^2}{2},
\end{equation}
\begin{equation}
e = \frac{p}{\gamma-1}+ \frac{\rho \bs{v}^2+\bs{B}^2}{2},
\end{equation}
where $\gamma=5/3$ denotes the ratio of specific heats. Solar gravitational acceleration is given by,
\begin{equation}
\bs{g}=-\frac{GM_{\odot}}{r^2}\hat{r},
\end{equation}
where $G$ is the gravitational constant and $M_{\odot}$ denotes the solar mass. \np
%
MPI-AMRVAC has been constructed to be a versatile piece of software, arming the user with a multitude of options. This reduces development time as rather than writing bespoke software for each simulation, modules of the code can efficiently be swapped or modified to produce the desired effect, e.g. changing physic modules, spatial/temporal solvers, grid setup and geometry, changing boundary conditions, and writing one's own custom routines.
%-------------------------------------
\subsection{Adaptive Mesh Refinement}
\label{ssec:amr}
%-------------------------------------
One of the main features of MPI-AMRVAC is the adaptive mesh refinement (AMR). Using AMR means that rather than having a static fixed resolution for the entirety of the simulation, we have a dynamical grid that adds/removes grid cells as needed. For example, see the differing mesh in Fig.~\ref{amr_example} from the test case of a hydrodynamic Rayleigh-Taylor Instability (RTI) (see Section~\ref{chap:tilted_jets} for more description of RTI). In this simulation, there is a denser fluid flowing downwards, and areas of highest resolution are located where rapid changes are occurring in the computational domain. In Fig.~\ref{amr_scheme}, we can see different levels of AMR being used. For example, cell (3,1) is the level one grid, which is the coarsest resolution initially defined by the user, cells (6,3) and (12,7) are level two and three respectively, with each cell half the size of the previous level. The rules that AMR are allocated and deallocated are:
\begin{itemize}
    \item The AMR can only be one level higher than its neighbouring cells.
    \item If the measured local numerical error is greater (lesser) than the user set threshold, the level of the grid cell is increased (decreased).
\end{itemize}
It is advantageous to use AMR in our simulations as it allows for computationally efficient placement of grid cells to resolve steep gradients, such as the TR and boundaries of the jet, as well as capturing the small scale dynamics.  
%fffffffffffffffffffffffff
\begin{figure}
\centering
\includegraphics[width = 0.8\textwidth]{figures/RTI_example.png}
\caption{Example of AMR mesh for RTI. Notice there is an increased number of grid cells around dynamic regions.: \url{http://amrvac.org/md_doc_examples.html}}.
\label{amr_example}
\end{figure}   
%fffffffffffffffffffffffff
This means that one can increase the grid cells in regions of interest (i.e. where smaller scale dynamics are occurring) based on the numerical error without having to increase the resolution of the whole domain, which would be computationally expensive.
\begin{figure}
\centering
\includegraphics[width = 0.8\textwidth]{figures/amrpng.png}
\caption{A generic AMR block skeleton from: \url{http://amrvac.org/md_doc_amrstructure.html}}.
\label{amr_scheme}
\end{figure}   
%------------------------------------------------------------------------------
\subsection{Atmospheric Equilibrium}
\label{sec:atmos_equil}
%------------------------------------------------------------------------------
To model synthetic jets, we need to construct a stratified atmosphere similar to solar conditions. We place the TR at $2$ Mm where the temperature smoothly connects an $8000$ K photosphere to $1.5$ MK corona as shown in \fref{atoms_profile}. The temperature of the atmosphere as a function of height is mathematically represented as,   
\begin{equation}\label{te_pro}
T_0(y>0) = T_{ch}+\frac{T_{c} - T_{ch}}{2} \left[ \tanh \left( \frac{y-y_{tr}}{w_{tr}} \right)+1 \right],
\end{equation}
where $y$ is the vertical position, $T_0(0)=T_{ch}=8\times10^3 \ \rm{K}$ ($T_{c}=1.8\times10^6 \ \rm{K}$) is the chromospheric (coronal) temperature and $y_{tr}=2$ Mm ($w_{tr}=0.02$ Mm) is the TR height (width). There is a uniform vertical magnetic, hence $\bs{j} \times \bs{B}=0$ and magnetohydrostatic equilibrium is achieved with,
\begin{equation}
\frac{dp}{dy} = - \rho g.
\end{equation}
Temperature and pressure are related through the ideal gas law,
\begin{equation}
p = \frac{ \rho \rgas T}{M},
\end{equation} 
where $M$ is the mean atomic weight, $T$ is the temperature and $\rgas$ is the universal gas constant. Therefore, one can obtain the $\rho$ and $p$ in the following form,  
\begin{equation}\label{p_pro}
p(y) = p_0 \exp \left( - \int_0^y  \frac{1}{H(y')} dy' \right), 
\end{equation} 
\begin{equation}\label{rho_pro}
\rho(y) = \rho_0 \frac{T_0}{T(y)} \exp \left( \int_0^y \frac{1}{H(y') }dy' \right),
\end{equation}
where $\rho_0$ and $p_0$ are the initial mass density and pressure equilibrium, respectively, at the lower boundary of the computational domain, and the pressure scale heights are given by,
\begin{equation}
H(y) = \frac{\rgas T(y)}{Mg}.
\end{equation}
Using the temperature profile given by \eref{te_pro} and taking $\rho_0 = 2.34e-4\times10^{-4}\;\rm{kg}\;\rm{m^{-3}}$ we construct pressure and mass density as function of height by means of \eref{p_pro} and \eref{rho_pro}.
%------------------------------------------------------------------------------
\subsection{Grid Setup}
\label{sec:Grid_Setup}
%------------------------------------------------------------------------------
We set the domain size to $50$ Mm $\times$ $30$ Mm with a level one resolution of $32$ $\times$ $24$ (giving a physical resolution of $\sim$ $1.56$ Mm $\times$ $1.25$ Mm). This coarse level one resolution was chosen to allow the dissipation of shocks as they travel towards the boundaries. To accurately capture the sharpness of the TR, we applied 7 levels of AMR giving a spatial resolution of $\sim$ $12$ km$\times$ $10$ km. We used unidirectional grid stretching in the horizontal direction, where from the origin the grid cells change by a constant factor of $1.1$ from cell to cell. Due to the choice of discretisation scheme for the boundary conditions, we employed ghost cells of 2 grid layers encasing the physical domain in each direction, which have a physical size of $3~\rm{Mm}$. The numerical scheme applied for spatial discretisation is HLL (Harten-Lax-van Leer) \cite{hll_1983} and a third order \u{C}ada limiter \citep{CADA20094118} for the time discretisation. We used the Courant–Friedrichs–Lewy (CFL) number of $0.8$ and generalized Lagrangian multiplier (GLM)-MHD method to maintain $\bs{\nabla} \cdot \bs{B}=0$ \citep{DEDNER2002645}. For the left and right boundary, we utilised a periodic boundary condition. In the ghost cells of the lower boundary, we fixed $\rho$, $e$ and $\bs{B}$ to their initial values. In the ghost cells for the upper boundary the values for $\rho$, $e$ are determined by the gravitational stratification, and $\bs{B}$ was extrapolated assuming zero normal gradient. For both upper and lower boundaries, we took an antisymmetric boundary for the velocity components.
%fffffffffffffffffffffff
\mfig{1}{figures/numerical_Setup_lowres.png}{The top left plot displays an example of the grid at $t=0$. The top right plot shows initial temperature (red line) and density (blue dashed) stratification in the first $10$ Mm. The lower panels from left to right are an example of Gaussian distribution for $A=60$ km s$^{-1}$ and $j_w=187.5$ km marked by red points at $t=0$ and the driver velocity with $A=60$ km s$^{-1}$, $P=300$ s.}{atoms_profile}
%fffffffffffffffffffffffff
%------------------------------------------------------------------------------      
\subsection{Driver}
\label{subsec:driver}
%------------------------------------------------------------------------------
As the driving mechanisms of spicules is an open question, we assumed that the synthetic jet is driven by a momentum pulse from the photosphere to investigate whether simple drivers can recreate the dynamical behaviours of spicules. Rather than going for a pressure pulse, we decided to use a momentum pulse to simulate spicules, as we view spicules as a mass transfer from low heights, since to our knowledge this is yet to be investigated in a solar context. The jet is launched symmetrically by a driver in the centre of the computational domain which varies both spatially and temporally (see bottom panels Fig.~\ref{atoms_profile}). In the $x$-direction the jet velocity is Gaussian with the full width at half maximum (FWHM) of $187.5~\rm{km}$ ($j_w$) and as the jet evolves in time it will reach a switch off phase in which it will shut off with a hyperbolic tangent, as defined by,
\begin{equation}
    v_x(x) = \frac{-A\sin{\theta}}{2}\left( \tanh{\left( \frac{\pi (t-P)}{P}+ \pi \right) +1 } \right) \exp \left( - \left(\frac{x-x_0}{\Delta x} \right)^2  \right),
\end{equation}
\begin{equation}
    v_y(x) = \frac{-A\cos{\theta}}{2}\left( \tanh{\left( \frac{\pi (t-P)}{P}+ \pi \right) +1 } \right) \exp \left( - \left(\frac{x-x_0}{\Delta x} \right)^2  \right),
\end{equation}
where $A$ is the amplitude of the driver, $\theta$ is the tilt angle from the vertical, $P$ are the driver time, $t$ is time, $x$ is horizontal position, $x_0$ location of the central jet axis, $\theta$ is the launching angles, and the $\Delta x$ is based on FWHM of the jet width and is given by,
\begin{equation}
\Delta x = \dfrac{j_w}{2 \sqrt{2 \log{2}}},
\end{equation}
where $j_w$ is the jet width.